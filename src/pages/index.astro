---
import { ViewTransitions } from 'astro:transitions';
import Gallery from '../components/Gallery.astro';
import { fetchProjects } from '../lib/supabase';
import { initImages } from '../lib/images';
import '../styles/global.css';
import '../styles/mobile.css';

// Initialize images and fetch projects from Supabase at build time
await initImages();
const projects = await fetchProjects();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Architecture portfolio showcasing residential and commercial projects" />
    <title>Architecture Portfolio</title>
    <ViewTransitions />
  </head>
  <body>
    <div class="contact-border-left"></div>
    <div class="contact-border-right"></div>
    <Gallery projects={projects} />
    <script src="../scripts/modal.ts"></script>
    <script src="../scripts/smoothScroll.ts"></script>
    <script src="../scripts/preloader.ts"></script>
    <script src="../scripts/mobileTransition.ts"></script>
    <script>
      // Mobile info popup - use event delegation to survive ViewTransitions
      let infoPopupOpen = false;
      let infoScrollPositions: number[] = [];

      function openInfoPopup() {
        // Save scroll positions before opening
        infoScrollPositions = [];
        document.querySelectorAll('.gallery-row').forEach((row) => {
          infoScrollPositions.push(row.scrollLeft);
        });
        document.querySelector('.mobile-contact-popup')?.classList.add('open');
        infoPopupOpen = true;
        history.pushState({ infoOpen: true }, '');
      }

      function closeInfoPopup() {
        document.querySelector('.mobile-contact-popup')?.classList.remove('open');
        infoPopupOpen = false;
      }

      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        // Open popup when info button clicked
        if (target.closest('.mobile-info-btn')) {
          openInfoPopup();
          return;
        }

        // Close popup when close button clicked
        if (target.closest('.mobile-contact-popup__close')) {
          closeInfoPopup();
          history.back();
          return;
        }

        // Close popup when clicking backdrop
        if (target.classList.contains('mobile-contact-popup')) {
          closeInfoPopup();
          history.back();
        }
      });

      // Handle back button for info popup
      window.addEventListener('popstate', () => {
        if (infoPopupOpen) {
          closeInfoPopup();
          // Store for restoration after ViewTransitions
          (window as any).__pendingInfoScrollRestore = [...infoScrollPositions];
        }
      });

      // Restore scroll after ViewTransitions
      document.addEventListener('astro:page-load', () => {
        const scrollValues = (window as any).__pendingInfoScrollRestore;
        if (scrollValues) {
          const rows = document.querySelectorAll('.gallery-row');
          rows.forEach((row, i) => {
            const targetScroll = scrollValues[i] || 0;
            (row as HTMLElement).style.scrollSnapType = 'none';
            row.scrollLeft = targetScroll;
          });
          setTimeout(() => {
            rows.forEach((row) => {
              (row as HTMLElement).style.scrollSnapType = '';
            });
          }, 50);
          (window as any).__pendingInfoScrollRestore = null;
        }
      });
    </script>
  </body>
</html>
