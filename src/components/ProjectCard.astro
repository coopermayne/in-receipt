---
import {
  getImage,
  getMobileThumbnail,
  getDesktopThumbnail,
  getMobileGalleryImage,
  getLeftPanelGalleryImage,
  getRightPanelGalleryImage,
} from '../lib/images';

interface Props {
  id: string;
  title: string;
  category: 'big' | 'small';
  thumbnail: string;
  shortDescription: string;
  fullDescription: string;
  images: string[];
  year?: string;
  location?: string;
  type?: string;
  isFirst?: boolean;
}

const { id, title, category, thumbnail, shortDescription, fullDescription, images, year, location, type, isFirst = false } = Astro.props;

// Get thumbnail data for mobile and desktop contexts
const mobileThumb = getMobileThumbnail(thumbnail, category);
const desktopThumb = getDesktopThumbnail(thumbnail, category);

// Prepare gallery images for both mobile (expanded) and desktop (panels)
const mobileGalleryImages = images.map(imgId => ({
  id: imgId,
  ...getMobileGalleryImage(imgId),
}));

const leftPanelImages = images.map(imgId => ({
  id: imgId,
  ...getLeftPanelGalleryImage(imgId),
}));

const rightPanelImages = images.map(imgId => ({
  id: imgId,
  ...getRightPanelGalleryImage(imgId),
}));

// Data for JS (desktop panels use different image configs)
const projectData = JSON.stringify({
  leftPanelImages,
  rightPanelImages,
  year,
  location,
  type
});
---

<article
  class="project-card"
  data-project-id={id}
  data-project-title={title}
  data-project-description={fullDescription}
  data-project-data={projectData}
>
  <div class="project-card__inner">
    <div class="project-card__image-container">
      <picture>
        {/* Mobile: cropped based on category (3:4 big, 16:9 small) */}
        <source
          media="(max-width: 767px)"
          srcset={mobileThumb.srcset}
          sizes={mobileThumb.sizes}
        />
        {/* Desktop: context-aware sizing (24vw big, 12vw small) */}
        <source
          media="(min-width: 768px)"
          srcset={desktopThumb.srcset}
          sizes={desktopThumb.sizes}
        />
        <img
          class="project-card__image"
          src={desktopThumb.src}
          alt={desktopThumb.alt || title}
          loading={isFirst ? "eager" : "lazy"}
          fetchpriority={isFirst ? "high" : "auto"}
          style={`object-position: ${desktopThumb.focalPoint};`}
          data-thumbnail-id={thumbnail}
        />
      </picture>
    </div>
    <div class="project-card__content">
      <h2 class="project-card__title">{title}</h2>
      <p class="project-card__description">{shortDescription}</p>
    </div>
  </div>

  <!-- Mobile: Preloaded project content (hidden until clicked) -->
  <div class="project-card__expanded">
    <button class="project-card__close" aria-label="Close">&times;</button>
    <div class="project-card__expanded-content">
      <div class="project-card__expanded-meta">
        <div class="project-card__expanded-meta-item">
          <span class="project-card__expanded-meta-label">Year</span>
          <span class="project-card__expanded-meta-value">{year || '—'}</span>
        </div>
        <div class="project-card__expanded-meta-item">
          <span class="project-card__expanded-meta-label">Location</span>
          <span class="project-card__expanded-meta-value">{location || '—'}</span>
        </div>
        <div class="project-card__expanded-meta-item">
          <span class="project-card__expanded-meta-label">Type</span>
          <span class="project-card__expanded-meta-value">{type || '—'}</span>
        </div>
      </div>
      <p class="project-card__expanded-description">{fullDescription}</p>
      <div class="project-card__expanded-gallery">
        {mobileGalleryImages.map((img) => (
          <img
            src={img.src}
            srcset={img.srcset}
            sizes={img.sizes}
            alt={img.alt}
            loading="lazy"
            style={`object-position: ${img.focalPoint};`}
          />
        ))}
      </div>
    </div>
  </div>
</article>
